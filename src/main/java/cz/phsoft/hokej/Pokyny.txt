Po vytvoření databáze v databázi vytvořit trigery pro historii registrací:
SQL:

CREATE TABLE IF NOT EXISTS match_registration_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    match_registration_id BIGINT NOT NULL,
    match_id BIGINT NOT NULL,
    player_id BIGINT NOT NULL,

    status VARCHAR(50) NOT NULL,
    excuse_reason VARCHAR(50),
    excuse_note TEXT,
    admin_note TEXT,
    jersey_color VARCHAR(50),

    original_timestamp DATETIME NOT NULL,
    created_by VARCHAR(255) NOT NULL,

    action VARCHAR(20) NOT NULL, -- INSERT / UPDATE / DELETE
    changed_at DATETIME NOT NULL -- NOW() při provedení triggeru
);

DELIMITER $$

-- INSERT TRIGGER
CREATE TRIGGER trg_match_reg_insert
AFTER INSERT ON match_registrations
FOR EACH ROW
BEGIN
    INSERT INTO match_registration_history
    (match_registration_id, match_id, player_id, status, excuse_reason,
     excuse_note, admin_note, jersey_color, original_timestamp, created_by,
     action, changed_at)
    VALUES
    (NEW.id, NEW.match_id, NEW.player_id, NEW.status, NEW.excuse_reason,
     NEW.excuse_note, NEW.admin_note, NEW.jersey_color, NEW.timestamp, NEW.created_by,
     'INSERT', NOW());
END$$

-- UPDATE TRIGGER
CREATE TRIGGER trg_match_reg_update
AFTER UPDATE ON match_registrations
FOR EACH ROW
BEGIN
    INSERT INTO match_registration_history
    (match_registration_id, match_id, player_id, status, excuse_reason,
     excuse_note, admin_note, jersey_color, original_timestamp, created_by,
     action, changed_at)
    VALUES
    (NEW.id, NEW.match_id, NEW.player_id, NEW.status, NEW.excuse_reason,
     NEW.excuse_note, NEW.admin_note, NEW.jersey_color, NEW.timestamp, NEW.created_by,
     'UPDATE', NOW());
END$$

-- DELETE TRIGGER
CREATE TRIGGER trg_match_reg_delete
AFTER DELETE ON match_registrations
FOR EACH ROW
BEGIN
    INSERT INTO match_registration_history
    (match_registration_id, match_id, player_id, status, excuse_reason,
     excuse_note, admin_note, jersey_color, original_timestamp, created_by,
     action, changed_at)
    VALUES
    (OLD.id, OLD.match_id, OLD.player_id, OLD.status, OLD.excuse_reason,
     OLD.excuse_note, OLD.admin_note, OLD.jersey_color, OLD.timestamp, OLD.created_by,
     'DELETE', NOW());
END$$

DELIMITER ;

------

Trigger pro player_activity_period
----


DELIMITER $$

-- AFTER INSERT
CREATE TRIGGER trg_update_player_status_after_insert
AFTER INSERT ON player_activity_period
FOR EACH ROW
BEGIN
    UPDATE player_entity
    SET is_active = CASE
        -- pokud hráč nemá žádný záznam → aktivní
        WHEN (SELECT COUNT(*) FROM player_active_periods p WHERE p.player_id = NEW.player_id) = 0 THEN 1
        -- pokud existuje interval obsahující NOW() → aktivní
        WHEN EXISTS (
            SELECT 1
            FROM player_active_periods p
            WHERE p.player_id = NEW.player_id
              AND NOW() BETWEEN p.active_from AND p.active_to
        ) THEN 1
        ELSE 0
    END
    WHERE id = NEW.player_id;
END $$

DELIMITER ;

